{% extends 'store/main.html' %} {% load static %} {% block content %}
<div class="row">
  <div class="col-lg-6">
    <div class="box-element">
      <a class="btn btn-outline-dark" href="{% url 'cart' %}"
        >&#x2190; Back to Cart</a
      >
      <hr />
      <h3>M-Pesa Payment</h3>
      <hr />
      <form id="mpesa-form">
        {% csrf_token %}
        <div class="form-field">
          <input
            required
            class="form-control"
            type="text"
            name="phone"
            placeholder="Phone Number (e.g., 2547XXXXXXXX)" />
        </div>
        <div class="form-field">
          <input
            required
            class="form-control"
            type="number"
            name="amount"
            placeholder="Amount (KES)" />
        </div>
        <hr />
        <button
          id="mpesa-button"
          class="btn btn-success btn-block"
          type="submit">
          Pay with M-Pesa
        </button>
      </form>
      <div id="processing-message" class="hidden">
        <hr />
        <p>
          Processing M-Pesa payment... Please wait for the prompt on your phone.
        </p>
      </div>
      <div id="payment-response" class="hidden">
        <hr />
        <p id="response-text"></p>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="box-element">
      <h3>Order Summary</h3>
      <hr />
      {% for item in items %}
      <div class="cart-row">
        <div style="flex: 2">
          <img class="row-image" src="{{item.product.imageURL}}" />
        </div>
        <div style="flex: 2"><p>{{item.product.name}}</p></div>
        <div style="flex: 1">
          <p>Ksh{{item.product.price|floatformat:2}}</p>
        </div>
        <div style="flex: 1"><p>x{{item.quantity}}</p></div>
      </div>
      {% endfor %}
      <h5>Items: {{order.get_cart_items}}</h5>
      <h5>Total: Ksh{{order.get_cart_total|floatformat:2}}</h5>
    </div>
  </div>
</div>

<script type="text/javascript">
  let mpesaForm = document.getElementById("mpesa-form");
  let mpesaButton = document.getElementById("mpesa-button");
  let processingMessage = document.getElementById("processing-message");
  let paymentResponse = document.getElementById("payment-response");
  let responseText = document.getElementById("response-text");

  mpesaForm.addEventListener("submit", function (e) {
    e.preventDefault();

    mpesaButton.classList.add("hidden");
    processingMessage.classList.remove("hidden");

    let phone = mpesaForm.phone.value;
    let amount = mpesaForm.amount.value;
    let url = "/payments/stk-push/";

    fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": "{{ csrf_token }}", // Ensure you have the CSRF token in your template
      },
      body: `phone=${phone}&amount=${amount}`,
    })
      .then((response) => response.json())
      .then((data) => {
        processingMessage.classList.add("hidden");
        paymentResponse.classList.remove("hidden");
        responseText.textContent = JSON.stringify(data); // Display the raw response for now
        // You might want to handle different response codes and messages here
      })
      .catch((error) => {
        console.error("Error:", error);
        processingMessage.classList.add("hidden");
        paymentResponse.classList.remove("hidden");
        responseText.textContent = "Error initiating M-Pesa payment.";
      });
  });
</script>
{% endblock content %}
