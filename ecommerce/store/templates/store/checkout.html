{% extends 'store/main.html' %} {% load static %} {% block content %}
<div class="row">
  <div class="col-lg-6">
    <div class="box-element">
      <a class="btn btn-outline-dark" href="{% url 'cart' %}"
        >&#x2190; Back to Cart</a
      >
      <hr />
      <h3>M-Pesa Payment</h3>
      <hr />
      <form id="mpesa-form">
        {% csrf_token %}
        <input
          type="hidden"
          name="order_id"
          id="order_id"
          value="{{ order.id }}" />
        <div class="form-field">
          <input
            required
            class="form-control"
            type="text"
            name="phone"
            id="phone"
            placeholder="Phone Number (e.g., 2547XXXXXXXX)" />
        </div>
        <hr />
        <button
          id="mpesa-button"
          class="btn btn-success btn-block"
          type="submit">
          Pay with M-Pesa
        </button>
      </form>
      <div id="payment-message" style="margin-top: 15px"></div>
      <div
        id="payment-response"
        class="hidden"
        style="margin-top: 15px; color: red">
        <strong id="response-text"></strong>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="box-element">
      <h3>Order Summary</h3>
      <hr />
      {% for item in items %}
      <div class="cart-row">
        <div style="flex: 2">
          <img class="row-image" src="{{item.product.imageURL}}" />
        </div>
        <div style="flex: 2"><p>{{item.product.name}}</p></div>
        <div style="flex: 1">
          <p>Ksh{{item.product.price|floatformat:2}}</p>
        </div>
        <div style="flex: 1"><p>x{{item.quantity}}</p></div>
      </div>
      {% endfor %}
      <h5>Items: {{order.get_cart_items}}</h5>
      <h5>Total: Ksh{{order.get_cart_total|floatformat:2}}</h5>
    </div>
  </div>
</div>

<script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("mpesa-form");
    const messageDiv = document.getElementById("payment-message");
    const paymentResponseDiv = document.getElementById("payment-response");
    const responseText = document.getElementById("response-text");

    let transactionId = null; // To store the transaction ID
    let pollInterval = null;
    const timeoutMs = 1.6 * 60 * 1000; // 1 minute 36 seconnds

    function pollPaymentStatus() {
      if (!transactionId) return;

      fetch(`/payment/status/?transaction_id=${transactionId}`)
        .then((response) => response.json())
        .then((data) => {
          if (data.status === "COMPLETED") {
            clearInterval(pollInterval);
            window.location.href = "/payment-success/"; // Or show success message
          } else if (data.status === "FAILED" || data.status === "TIMEOUT") {
            clearInterval(pollInterval);
            responseText.textContent =
              "Payment timed out or failed. Please try again.";
            paymentResponseDiv.classList.remove("hidden");
          }
        })
        .catch((error) => {
          console.error("Error polling payment status:", error);
          // Optionally handle network errors during polling
        });
    }

    function startPolling() {
      pollInterval = setInterval(pollPaymentStatus, 5000); // Poll every 5 seconds
      setTimeout(() => {
        clearInterval(pollInterval);
        if (paymentResponseDiv.classList.contains("hidden")) {
          responseText.textContent = "Payment timed out. Please try again.";
          paymentResponseDiv.classList.remove("hidden");
        }
      }, timeoutMs);
    }

    form.addEventListener("submit", function (e) {
      e.preventDefault();
      const phone = document.getElementById("phone").value;
      const order_id = document.getElementById("order_id").value;

      const csrfToken = document.querySelector(
        "[name=csrfmiddlewaretoken]"
      ).value;
      messageDiv.innerHTML = "Processing payment...";
      paymentResponseDiv.classList.add("hidden"); // Ensure previous messages are hidden

      fetch("/payment/stk-push/", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": csrfToken,
        },
        body: `phone=${encodeURIComponent(phone)}&order_id=${encodeURIComponent(
          order_id
        )}`,
      })
        .then((response) => response.json()) // Expect JSON response
        .then((data) => {
          if (data.error) {
            messageDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
          } else if (data.transaction_id) {
            // Payment initiation was successful, start polling
            transactionId = data.transaction_id;
            startPolling();
            messageDiv.innerHTML = "Awaiting M-Pesa confirmation...";
          } else {
            messageDiv.innerHTML = `<div class="alert alert-danger">An unexpected error occurred. Please check your phone and try again.</div>`;
          }
        })
        .catch((err) => {
          messageDiv.innerHTML = `<div class="alert alert-danger">An error occurred. Please try again.</div>`;
        });
    });
  });
</script>
{% endblock content %}
