{% extends 'store/main.html' %} {% load static %} {% block content %}
<div class="row">
  <div class="col-lg-6">
    <div class="box-element">
      <a class="btn btn-outline-dark" href="{% url 'cart' %}"
        >&#x2190; Back to Cart</a
      >
      <hr />
      <h3>M-Pesa Payment</h3>
      <hr />
      <form id="mpesa-form">
        {% csrf_token %}
        <input
          type="hidden"
          name="order_id"
          id="order_id"
          value="{{ order.id }}" />
        <input
          type="hidden"
          name="amount"
          id="amount"
          value="{{ order.get_cart_total|floatformat:2 }}" />
        <div class="form-field">
          <input
            required
            class="form-control"
            type="text"
            name="phone"
            id="phone"
            placeholder="Phone Number (e.g., 2547XXXXXXXX)" />
        </div>
        <hr />
        <button
          id="mpesa-button"
          class="btn btn-success btn-block"
          type="submit">
          Pay with M-Pesa
        </button>
      </form>
      <div id="payment-message" style="margin-top: 15px"></div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="box-element">
      <h3>Order Summary</h3>
      <hr />
      {% for item in items %}
      <div class="cart-row">
        <div style="flex: 2">
          <img class="row-image" src="{{item.product.imageURL}}" />
        </div>
        <div style="flex: 2"><p>{{item.product.name}}</p></div>
        <div style="flex: 1">
          <p>Ksh{{item.product.price|floatformat:2}}</p>
        </div>
        <div style="flex: 1"><p>x{{item.quantity}}</p></div>
      </div>
      {% endfor %}
      <h5>Items: {{order.get_cart_items}}</h5>
      <h5>Total: Ksh{{order.get_cart_total|floatformat:2}}</h5>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("mpesa-form");
    form.addEventListener("submit", function (e) {
      e.preventDefault();
      const phone = document.getElementById("phone").value;
      const order_id = document.getElementById("order_id").value;
      const amount = document.getElementById("amount").value;
      const csrfToken = document.querySelector(
        "[name=csrfmiddlewaretoken]"
      ).value;
      const messageDiv = document.getElementById("payment-message");
      messageDiv.innerHTML = "Processing payment...";

      fetch("/payments/stk-push/", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": csrfToken,
        },
        body: `phone=${encodeURIComponent(phone)}&order_id=${encodeURIComponent(
          order_id
        )}`,
      })
        .then((response) => response.text())
        .then((data) => {
          // Try to parse as JSON, fallback to HTML
          try {
            const json = JSON.parse(data);
            if (json.error) {
              messageDiv.innerHTML = `<div class="alert alert-danger">${json.error}</div>`;
            }
          } catch {
            // Assume HTML (success/failure template)
            messageDiv.innerHTML = data;
          }
        })
        .catch((err) => {
          messageDiv.innerHTML = `<div class="alert alert-danger">An error occurred. Please try again.</div>`;
        });
    });
  });
</script>
{% endblock content %}
